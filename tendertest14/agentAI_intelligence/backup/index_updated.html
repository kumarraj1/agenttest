<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Procurement Event</title>
    <script>
        function submitEvent() {
            const buyerInput = {
                base_language: document.getElementById("base_language").value,
                regions: document.getElementById("regions").value,
                departments: document.getElementById("departments").value,
                currency: document.getElementById("currency").value,
                commodity: document.getElementById("commodity").value,
                contract_months: document.getElementById("contract_months").value,
                contract_effective_date: document.getElementById("contract_effective_date").value,
                quantity: document.getElementById("quantity").value,
                budget: document.getElementById("budget").value
            };

            fetch('/get_suppliers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(buyerInput)
            })
            .then(response => response.json())
            .then(data => displayRecommendations(data))
            .catch(error => alert("Error fetching suppliers: " + error));
        }

        function displayRecommendations(data) {
            const container = document.getElementById("recommendations");
            container.innerHTML = "<h2>Supplier Recommendations</h2>";
            if (data.error) {
                container.innerHTML += `<p>Error: ${data.error}</p>`;
                return;
            }

            const suppliers = data.ranked_suppliers;
            const insights = data.ai_insights;

            suppliers.forEach((supplier, index) => {
                container.innerHTML += `
                    <div>
                        <input type="checkbox" class="supplier-checkbox" value="${supplier.supplier_name}">
                        <strong>${index + 1}. ${supplier.supplier_name}</strong> (Score: ${supplier.score})<br>
                        Reason: ${supplier.ranking_reason}<br>
                        Explanation: ${supplier.explanation}<br>
                        Match: ${supplier.match_percentage}%<br>
                        Region: ${supplier.region}<br>
                        Risks: ${supplier.risks.join(", ")}<br>
                        <strong>AI Insights:</strong>
                        <ul>
                            <li>Trends: ${supplier.ai_insights.trends.join(", ")}</li>
                            <li>Optimizations: ${supplier.ai_insights.optimizations.join(", ")}</li>
                        </ul>
                    </div>
                `;
            });

            container.innerHTML += `
                <h3>Global AI Insights</h3>
                <p><strong>Trends:</strong> ${insights.trends.join(", ")}</p>
                <p><strong>Risks:</strong> ${insights.risks.join(", ")}</p>
                <p><strong>Optimizations:</strong> ${insights.optimizations.join(", ")}</p>
                <button onclick="proceedToEdit()">Edit and Publish</button>
            `;
        }

        function proceedToEdit() {
            const selectedSuppliers = [];
            document.querySelectorAll(".supplier-checkbox:checked").forEach(checkbox => {
                selectedSuppliers.push(checkbox.value);
            });

            if (selectedSuppliers.length === 0) {
                alert("Please select at least one supplier.");
                return;
            }

            fetch('/edit_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_suppliers: selectedSuppliers })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.href = "/edit_event"; // Redirect to edit event page
                }
            })
            .catch(error => alert("Error proceeding to edit page: " + error));
        }
    </script>
</head>
<body>
    <h1>Create Procurement Event</h1>
    <form>
        <label>Base Language:</label>
        <input type="text" id="base_language" required><br><br>
        <label>Regions:</label>
        <input type="text" id="regions" required><br><br>
        <label>Departments:</label>
        <input type="text" id="departments" required><br><br>
        <label>Currency:</label>
        <input type="text" id="currency" required><br><br>
        <label>Commodity:</label>
        <input type="text" id="commodity" required><br><br>
        <label>Contract Months:</label>
        <input type="number" id="contract_months" required><br><br>
        <label>Contract Effective Date:</label>
        <input type="date" id="contract_effective_date" required><br><br>
        <label>Quantity:</label>
        <input type="number" id="quantity" required><br><br>
        <label>Budget:</label>
        <input type="number" id="budget" required><br><br>
        <button type="button" onclick="submitEvent()">Submit</button>
    </form>
    <div id="recommendations"></div>
</body>
</html>
